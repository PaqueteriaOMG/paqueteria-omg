<div class="package-list">
  <div class="list-header">
    <div class="header-info">
      <h2 class="list-title">Gestión de Paquetes</h2>
      <p class="list-subtitle">Administra todos los envíos y paquetes</p>
    </div>
    <div class="header-actions">
      <div class="view-toggle">
        <button 
          class="btn btn-outline" 
          [class.active]="viewMode === 'individual'"
          (click)="setViewMode('individual')"
        >
          Vista Individual
        </button>
        <button 
          class="btn btn-outline" 
          [class.active]="viewMode === 'grouped'"
          (click)="setViewMode('grouped')"
        >
          Vista Agrupada
        </button>
      </div>
      <button class="btn btn-primary" routerLink="/paquetes/nuevo">
        <svg width="20" height="20" fill="currentColor" viewBox="0 0 20 20">
          <path fill-rule="evenodd" d="M10 5a1 1 0 011 1v3h3a1 1 0 110 2h-3v3a1 1 0 11-2 0v-3H6a1 1 0 110-2h3V6a1 1 0 011-1z"/>
        </svg>
        Nuevo Paquete
      </button>
    </div>
  </div>

  <div class="filters-section card">
    <div class="filters-grid">
      <div class="search-group">
        <label class="form-label">Buscar paquetes</label>
        <div class="search-input">
          <svg width="20" height="20" fill="currentColor" viewBox="0 0 20 20">
            <path fill-rule="evenodd" d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z"/>
          </svg>
          <input 
            type="text" 
            [(ngModel)]="searchQuery"
            (input)="onSearchChange()"
            placeholder="Buscar por número de seguimiento, remitente, destinatario..."
            class="form-input"
          >
        </div>
      </div>
      
      <div class="filter-group">
        <label class="form-label">Filtrar por estado</label>
        <select [(ngModel)]="selectedStatus" (change)="onStatusChange()" class="form-input">
          <option value="">Todos los estados</option>
          <option value="pending">Pendientes</option>
          <option value="in_transit">En Tránsito</option>
          <option value="delivered">Entregados</option>
          <option value="returned">Devueltos</option>
        </select>
      </div>
    </div>
  </div>

  <div class="packages-section">

    <!-- ===== Vista INDIVIDUAL ===== -->
    <ng-container *ngIf="viewMode === 'individual'">
      <div class="packages-grid" *ngIf="filteredPackages$ | async as packages">
        <div class="package-card card" *ngFor="let package of packages; trackBy: trackByPackageId" [class.fade-in]="true">
          <div class="package-header">
            <div class="tracking-info">
              <h3 class="tracking-number">{{ package.tracking_number }}</h3>
              <span [class]="'status-badge status-' + package.status">
                {{ getStatusText(package.status) }}
              </span>
            </div>
            <div class="package-actions">
              <button class="btn-icon" (click)="editPackage(package.id)" title="Editar">
                <svg width="16" height="16" fill="currentColor" viewBox="0 0 20 20">
                  <path d="M13.586 3.586a2 2 0 112.828 2.828l-.793.793-2.828-2.828.793-.793zM11.379 5.793L3 14.172V17h2.828l8.38-8.379-2.83-2.828z"/>
                </svg>
              </button>
              <button class="btn-icon delete" (click)="deletePackage(package.id)" title="Eliminar">
                <svg width="16" height="16" fill="currentColor" viewBox="0 0 20 20">
                  <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z"/>
                </svg>
              </button>
            </div>
          </div>
          
          <div class="package-content">
            <div class="package-route">
              <div class="route-item">
                <div class="route-label">Remitente</div>
                <div class="route-name">{{ package.sender_name }}</div>
                <div class="route-address">{{ package.sender_address }}</div>
              </div>
              <div class="route-arrow">
                <svg width="24" height="24" fill="currentColor" viewBox="0 0 24 24">
                  <path d="M16.01 11H4v2h12.01v3L20 12l-3.99-4z"/>
                </svg>
              </div>
              <div class="route-item">
                <div class="route-label">Destinatario</div>
                <div class="route-name">{{ package.recipient_name }}</div>
                <div class="route-address">{{ package.recipient_address }}</div>
              </div>
            </div>
            
            <div class="package-details">
              <div class="detail-row">
                <span class="detail-label">Descripción:</span>
                <span class="detail-value">{{ package.description }}</span>
              </div>
              <div class="detail-row">
                <span class="detail-label">Peso:</span>
                <span class="detail-value">{{ package.weight }} kg</span>
              </div>
              <div class="detail-row">
                <span class="detail-label">Cantidad:</span>
                <span class="detail-value">{{ package.quantity }} {{ package.quantity === 1 ? 'producto' : 'productos' }}</span>
              </div>
              <div class="detail-row">
                <span class="detail-label">Dimensiones:</span>
                <span class="detail-value">{{ package.dimensions }}</span>
              </div>
              <div class="detail-row">
                <span class="detail-label">Entrega estimada:</span>
                <span class="detail-value">{{ formatDate(package.estimated_delivery) }}</span>
              </div>
            </div>
          </div>
          
          <div class="package-footer">
            <div class="package-dates">
              <small class="created-date">
                Creado: {{ formatDate(package.created_at) }}
              </small>
              <small class="updated-date">
                Actualizado: {{ formatDate(package.updated_at) }}
              </small>
            </div>
          </div>
        </div>
      </div>

      <div class="empty-state" *ngIf="(filteredPackages$ | async)?.length === 0">
        <div class="empty-icon">
          <svg width="64" height="64" fill="currentColor" viewBox="0 0 20 20">
            <path fill-rule="evenodd" d="M5 2a1 1 0 011 1v1h1a1 1 0 010 2H6v1a1 1 0 01-2 0V6H3a1 1 0 010-2h1V3a1 1 0 011-1zm0 10a1 1 0 011 1v1h1a1 1 0 110 2H6v1a1 1 0 11-2 0v-1H3a1 1 0 110-2h1v-1a1 1 0 011-1zM12 2a1 1 0 01.967.744L14.146 7.2 17.5 9.134a1 1 0 010 1.732L14.146 12.8l-1.179 4.456a1 1 0 01-1.934 0L9.854 12.8 6.5 10.866a1 1 0 010-1.732L9.854 7.2l1.179-4.456A1 1 0 0112 2z"/>
          </svg>
        </div>
        <h3>No se encontraron paquetes</h3>
        <p>No hay paquetes que coincidan con los filtros actuales.</p>
        <button class="btn btn-primary" (click)="clearFilters()">Limpiar Filtros</button>
      </div>
    </ng-container>

    <!-- ===== Vista AGRUPADA ===== -->
    <ng-container *ngIf="viewMode === 'grouped'">
      <div class="packages-grid" *ngIf="groupedPackages$ | async as groups">
        <div class="package-card card" *ngFor="let g of groups; trackBy: trackByGroupKey">
          <div class="package-header group-header" (click)="toggleGroup(g.key)">
            <div class="tracking-info">
              <h3 class="tracking-number">{{ g.title }}</h3>
              <span class="status-badge">{{ g.packages.length }} {{ g.packages.length === 1 ? 'paquete' : 'paquetes' }}</span>
            </div>
            <button class="btn-icon" [class.rotated]="isGroupExpanded(g.key)" aria-label="Expandir/Colapsar">
              <svg width="16" height="16" viewBox="0 0 20 20" fill="currentColor">
                <path d="M5.23 7.21a.75.75 0 011.06.02L10 10.94l3.71-3.71a.75.75 0 111.06 1.06l-4.24 4.24a.75.75 0 01-1.06 0L5.21 8.29a.75.75 0 01.02-1.08z"/>
              </svg>
            </button>
          </div>

          <div class="group-content" *ngIf="isGroupExpanded(g.key)">
            <div class="package-card-inner" *ngFor="let package of g.packages; trackBy: trackByPackageId">
              <div class="package-content">
                <div class="package-route">
                  <div class="route-item">
                    <div class="route-label">Remitente</div>
                    <div class="route-name">{{ package.sender_name }}</div>
                    <div class="route-address">{{ package.sender_address }}</div>
                  </div>
                  <div class="route-arrow">
                    <svg width="24" height="24" fill="currentColor" viewBox="0 0 24 24">
                      <path d="M16.01 11H4v2h12.01v3L20 12l-3.99-4z"/>
                    </svg>
                  </div>
                  <div class="route-item">
                    <div class="route-label">Destinatario</div>
                    <div class="route-name">{{ package.recipient_name }}</div>
                    <div class="route-address">{{ package.recipient_address }}</div>
                  </div>
                </div>

                <div class="package-details">
                  <div class="detail-row">
                    <span class="detail-label">Tracking:</span>
                    <span class="detail-value">{{ package.tracking_number }}</span>
                  </div>
                  <div class="detail-row">
                    <span class="detail-label">Estado:</span>
                    <span class="detail-value">{{ getStatusText(package.status) }}</span>
                  </div>
                  <div class="detail-row">
                    <span class="detail-label">Entrega estimada:</span>
                    <span class="detail-value">{{ formatDate(package.estimated_delivery) }}</span>
                  </div>
                </div>
              </div>

              <div class="package-actions">
                <button class="btn btn-outline" (click)="editPackage(package.id)">Editar</button>
                <button class="btn btn-outline delete" (click)="deletePackage(package.id)">Eliminar</button>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="empty-state" *ngIf="(groupedPackages$ | async)?.length === 0">
        <div class="empty-icon">
          <svg width="64" height="64" fill="currentColor" viewBox="0 0 20 20">
            <path fill-rule="evenodd" d="M5 2a1 1 0 011 1v1h1a1 1 0 010 2H6v1a1 1 0 01-2 0V6H3a1 1 0 010-2h1V3a1 1 0 011-1zm0 10a1 1 0 011 1v1h1a1 1 0 110 2H6v1a1 1 0 11-2 0v-1H3a1 1 0 110-2h1v-1a1 1 0 011-1zM12 2a1 1 0 01.967.744L14.146 7.2 17.5 9.134a1 1 0 010 1.732L14.146 12.8l-1.179 4.456a1 1 0 01-1.934 0L9.854 12.8 6.5 10.866a1 1 0 010-1.732L9.854 7.2l1.179-4.456A1 1 0 0112 2z"/>
          </svg>
        </div>
        <h3>No se encontraron grupos</h3>
        <p>No hay paquetes que coincidan con los filtros actuales.</p>
        <button class="btn btn-primary" (click)="clearFilters()">Limpiar Filtros</button>
      </div>
    </ng-container>
  </div>
</div>